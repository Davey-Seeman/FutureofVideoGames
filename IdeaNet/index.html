<!--
	Template called Full Motion by TEMPLATED
	templated.co @templatedco
	Released for free under the Creative Commons Attribution 3.0 license (templated.co/license)
-->
<html>
	<head>
		<title>IdeaNet</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<link rel="stylesheet" href="assets/css/main.css" />
		<link rel="stylesheet" href="path/to/font-awesome/css/font-awesome.min.css">

		<!-- Firebase links -->
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
        <script src="https://www.gstatic.com/firebasejs/7.6.0/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/7.6.0/firebase-analytics.js"></script>
        <script src="https://www.gstatic.com/firebasejs/7.6.0/firebase-auth.js"></script>
        <script src="https://www.gstatic.com/firebasejs/7.6.0/firebase-database.js"></script>
        <script src="https://apis.google.com/js/platform.js" async defer></script>

	</head>
	<body id="top" onclick = "hideSuggested();">

		<!-- Header/Banner -->
			<section id="banner" class="header">
				<div class="inner">
					<header>
						<center><h1>IdeaNet</h1></center>
						<h2><i>Where Ideas Come to Life:</i></h2>
					</header>
				</div>
				<button id ="postBtn" type="button" class="fa fa-plus-square" data-toggle="modal" data-target="#postModal"></button> <!-- Add post button -->

			<!-- Post Idea Modal Popup -->
			  	<div id="postModal" class="modal">

				    <!-- Modal content -->
				    <div class="modal-content">
					    <div class="modal-header">
					        <h2>Add an Idea!</h2>
					    </div>
					    <div class="modal-body">
					        <center>
						        <p>Title</p>
						        <input id = "titleInput" type="text" class="descriptionInputs" placeholder="Add Your Idea Title (2 - 10 Words)">
						        <p>Description</p>
						        <textarea id = "descriptionInput" class="descriptionInputs" cols="40" rows="4" placeholder= "Give a more detailed overview of your idea (50 - 150 words)"></textarea>
						        <p>Target Audience</p>
						        <input id = "audienceInput" type="text" class="descriptionInputs" placeholder= "Who is your target audience? (1 - 8 Words)">
						        <p>Importance</p>
						        <textarea id = "importanceInput" class="descriptionInputs" cols="40" rows="2" placeholder= "Why is your idea important? (15 - 50 Words)"></textarea>
						        <p class="break"><br></p>
					    	</center>
					    </div>
					    <div class="modal-footer">
					        <h3>Attach an Image:</h3>
					        <input id="imageInput" type="text" class="imageInsert" placeholder="Image URL">
					        <div class="tooltip">
					        	<input id = "tagInput" type="text" class="tagInput" placeholder="Optional: add some tags (e.g. sports)">
								<span class="tooltiptext">Tags are Separated by Spaces</span>
							</div>
					        <input id="submit" class="submit" type="submit" value="Submit" onclick="addData()">

					    </div>
				    </div>
				</div>
			 <!-- End Post Idea Modal -->

			</section>

		<!-- Main Area - Post Area -->
			<div>

				<!-- Different sorting buttons dropdown -->
				<div class="sort-dropdown">
				  <button class="sortbtn">Sort by <i class="fa fa-angle-double-down"></i> </button>
				  <div class="sort-content"> 
				  	<br>
				    <button onclick = "sortByLikes();">Likes</button>
				    <br>
				    <button onclick = "sortByDate();">Newest</button>
				  </div>
				</div>

				<!-- Tag search dropdown -->

				<div class="tags-drp">
				  <input id = "searchInput" type="text" class="drop-inpt" oninput="showSuggested();" placeholder="Search for a Tag (e.g. sports)">
				  <div class="tagsdrp-content" id = "suggestions"></div>
				</div>

				<button class = "clearTags" onclick = "ref.once('value', gotList, errData);">Clear Tags <i class="fa fa-trash" aria-hidden="true"></i> </button>

				<button class="hiddenButton" id = "refresh" onClick="window.location.reload();"> Refresh the Page to see New Changes <i class="fa fa-refresh" style = "font-size: 70px;" aria-hidden="true"></i> </button>
				<div class="inner">

				<!-- Posts -->
					<div class="thumbnails" id="postSection">
					</div>
				</div>
			</div>

		<!-- Footer -->
			<footer id="footer">
				<div class="inner">
				</div>
			</footer>

		<script>

		var config = 
        {
            apiKey: "AIzaSyCgoPa8X6juYqo-hguA-bFxHpZNWMlDVeM",
		    authDomain: "ideanetbydaveyseeman.firebaseapp.com",
		    databaseURL: "https://ideanetbydaveyseeman-default-rtdb.firebaseio.com",
		    projectId: "ideanetbydaveyseeman",
		    storageBucket: "ideanetbydaveyseeman.appspot.com",
		    messagingSenderId: "265128709776",
		    appId: "1:265128709776:web:97a62d1a6970653dc1d215",
		    measurementId: "G-5R2GXVK9FV"
        };
    
        firebase.initializeApp(config);
        var database = firebase.database();
        var ref = database.ref("Ideas");
        ref.once("value", gotList, errData);

        ideaNumber = counter = 0;
        likedAlrdy = reportedAlrdy = false;
        dataHold = {}; //it saves many lines of code to make this global

        function gotList(data) //shows all the ideas on the browsing feed
        {	
        	postDisplay = document.getElementById("postSection").innerHTML = ""; //clear all posts (useful for when function is recalled in "clear tags" button)

            allData = dataHold = data.val() //val function turns data into dictionary

            keyValues = Object.keys(allData);  

            for (i = 0; i < keyValues.length; i++) //this will draw all the posts in the database, if my website gets too many posts I could change this number (keyValues.length) to only show some of them
            {
                databaseIdeas = database.ref("Ideas/" + keyValues[i]);
                databaseIdeas.once("value", gotData, errData);
            }
        }

        function gotData(data)
        {	
            fullData = data.val();
	     
	        showPost(fullData)
        }
    
        function errData(err)
        {
            console.log("Error!")
            console.log(err)
      	}

        function showPost (fullData)
        {
        	ideaNumber ++;

         	browsingData = [fullData.title, fullData.description, fullData.imageURL, fullData.likes]; //data that is shown on the browsing page
            if (browsingData[1].length > 120) {
            	browsingData[1] = browsingData[1].substring(0, 120) + "..."; //limit # of characters on browsing page description
            };

            postDisplay = document.getElementById("postSection");

            //create post:

            postButton = document.createElement("button"); //button that opens idea description page (the button is the entire post)
            postButton.className = "openBtn";
            postButton.setAttribute("id", "desBtn" + ideaNumber);
            postButton.setAttribute("data-toggle", "modal");
            postButton.setAttribute("data-target", "#descriptionPage" + ideaNumber);
            postButton.setAttribute("onclick", "(function (){likedAlrdy = reportedAlrdy = false;  window.scrollTo(0, 0);})()");

            postBox = document.createElement("div");
            postBox.className = "box"; 

            //contents of post:

            postImage = document.createElement("img");
            postImage.setAttribute("alt", "");
            postImage.setAttribute("src", browsingData[2]);
			postImage.className = "image-fit";
			postBox.appendChild(postImage);

			heartIcon = document.createElement("i"); //likes displayed on each post when hovered over
			heartIcon.className = "fa fa-heart"; //turn into icon class
			postBox.appendChild(heartIcon);
			likes = document.createElement("p");
			likes.setAttribute("id", "likesPost" + ideaNumber);
			likes.appendChild(document.createTextNode(browsingData[3])) //you need to put this text in a <p> because text nodes cannot be styled on their own
			likes.className = "likesTxt";
			postBox.appendChild(likes);


			innerText = document.createElement("div"); //div that stores title and description text
			title = document.createElement("h3");
			title.className = "postTitle";
			title.appendChild(document.createTextNode(browsingData[0]))
			innerText.appendChild(title);
			description = document.createElement("p");
			description.appendChild(document.createTextNode(browsingData[1]))
			description.className = "postDesTeaser";
			innerText.appendChild(description);
			innerText.style.transform = "translate(0px,-140px)"; 
			postBox.appendChild(innerText); //adds idea and description text to post box

			postButton.appendChild(postBox);
			postDisplay.appendChild(postButton); //a new post has just been added


			//creating contents on the idea description page:

			descriptionData = [fullData.title, fullData.description, fullData.targetAudience, fullData.importance, fullData.imageURL, fullData.likes, fullData.comments, fullData.tags]; //data that is shown on the idea description page.

			page = document.createElement("div");
			page.setAttribute("id", "descriptionPage" + ideaNumber); //index each idea description page
			page.className = "description-modal";

			content = document.createElement("div");
			content.className = "description-content";
			page.appendChild(content);

			header = document.createElement("div");
			header.className = "description-header";
			content.appendChild(header);

			titleText = document.createElement("p");
			titleText.appendChild(document.createTextNode(descriptionData[0]));
			header.appendChild(titleText);
			likesIcon = document.createElement("i");
			likesIcon.className = "fa fa-heart";
			likesIcon.style.visibility = "visible";
			likesIcon.setAttribute("id","likesOnPost" + ideaNumber);
			likesIcon.setAttribute("onclick","addLike(this);")
			header.appendChild(likesIcon);
			likesText = document.createElement("p");
			likesText.setAttribute("id", "likesCount" + ideaNumber);
			likesText.className = "likes-number";
			likesText.appendChild(document.createTextNode(descriptionData[5]));
			header.appendChild(likesText);

			body = document.createElement("div");
			body.className = "description-body";

			descriptionTitle = document.createElement("p");
			descriptionTitle.appendChild(document.createTextNode("Description"));
			body.appendChild(descriptionTitle);
			descriptionText = document.createElement("h5");
			descriptionText.appendChild(document.createTextNode(descriptionData[1]));
			body.appendChild(descriptionText);

			audienceTitle = document.createElement("p");
			audienceTitle.appendChild(document.createTextNode("Target Audience"));
			body.appendChild(audienceTitle);
			audienceText = document.createElement("h5");
			audienceText.appendChild(document.createTextNode(descriptionData[2]));
			body.appendChild(audienceText);


			importanceTitle = document.createElement("p");
			importanceTitle.appendChild(document.createTextNode("Importance"));
			body.appendChild(importanceTitle);
			importanceText = document.createElement("h5");
			importanceText.appendChild(document.createTextNode(descriptionData[3]));
			body.appendChild(importanceText);
			body.appendChild(document.createElement("br"));

			image = document.createElement("img");
			image.setAttribute("src", descriptionData[4]);
			image.className = "description-image";
			body.appendChild(image);


			reportBtn = document.createElement("p"); //creating report button
			reportBtn.className = "fa fa-exclamation-triangle";
			reportBtn.appendChild(document.createTextNode("Report "));
			reportBtn.setAttribute("id", "reportButton" + ideaNumber);
			reportBtn.setAttribute("onclick", "reported(this);");
			body.appendChild(reportBtn);

			tagsIcon = document.createElement("i"); //add tags to body (not header because it has seperate styling)
			tagsIcon.className = "fa fa-tags";
			body.appendChild(tagsIcon);
			tags = document.createElement("p");
			tags.className = "tagsTxt";

			tagsText = descriptionData[7].join(", "); //turns list of tags into string w vals separated by commas
			if  (tagsText.length > 55){
				tagsText = tagsText.substring(0, 55) + "..."; //limit to only 55 chars to make sure it will fit in the header
			};

			tags.appendChild(document.createTextNode(tagsText));
			body.appendChild(tags);

			commentSec = document.createElement("div");
			commentSec.setAttribute("id", "commentList" + ideaNumber);
			commentSec.className = "comment-section";
			body.appendChild(commentSec);
			commentTitle = document.createElement("p");
			commentTitle.appendChild(document.createTextNode("Comments"));
			commentTitle.className = "comment-title";
			commentSec.appendChild(commentTitle);

			//adding comments to post:

			databaseComments = database.ref("Ideas/" + "Idea" + ideaNumber + "/comments");
			counter = 0;
			databaseComments.once("value", gotComments, errData);

			content.appendChild(body);


			footer = document.createElement("div");
			footer.class = "insertComment";

			inputCom = document.createElement("input");
			inputCom.className = "commentInput";
			inputCom.setAttribute("type", "text");
			inputCom.setAttribute("id", "commentTxt" + ideaNumber);
			inputCom.setAttribute("placeholder", "Add a comment...");
			footer.appendChild(inputCom);
			submitBtn = document.createElement("submit");
			submitBtn.className = "commentSubmit";
			footer.appendChild(submitBtn);
			submitIcon = document.createElement("i")
			submitIcon.className = "fa fa-paper-plane";

			submitBtn.setAttribute("id", "commentSection" + ideaNumber);

			submitBtn.appendChild(submitIcon);
			submitBtn.setAttribute("onclick", "addComment(this)");

			page.append(footer);

			postDisplay.appendChild(page);
        };

        function gotComments(data){
        	counter ++;
			commentData = data.val();
			allComments = Object.values(commentData);

			ideaComments = document.getElementById("commentList" + counter);

			for (i = 0; i < allComments.length; i++){
				comment = document.createElement("p");
				comment.className = "idea-comments";
				comment.appendChild(document.createTextNode(allComments[i]));
				ideaComments.appendChild(comment);
			};
		};

        function addData() //adds new idea to the database
      	{
      		ideaNumber ++;

        	tit = document.getElementById("titleInput").value;
        	des = document.getElementById("descriptionInput").value;
        	aud = document.getElementById("audienceInput").value;
        	imp = document.getElementById("importanceInput").value;
        	img = document.getElementById("imageInput").value;
        	tags = document.getElementById("tagInput").value;

        	tagArr = tags.split(" ");
        	tagObj = {};

        	for (var i = 0; i < tagArr.length; i++){ //contstruct obj containing all inputted tags w each word from input
        		tagObj[i] = tagArr[i];
        	};

        	if(tit.length > 0 && des.length > 0 && aud.length > 0 && imp.length == 0){  //end function if not all input boxes are full on idea submit page
        		alert("Please input in all fields");
            	return;
            };

            fetch(new Request(img, {method: 'HEAD', mode: 'no-cors'}))  //also check if image is valid seperatedly as it is a success criteria
                .catch(function() { //case where img is invalid
                    if(confirm("You are sumbitting a post without an image, is that ok?") == false){ //confirmation
	            			return;
            	    }
                });

            //function will continue if url is valid or user clicked "Ok" in response to the invalid image confirmation

    		var data = //Idea data

                {
                    title: tit,
                    description: des,
                    targetAudience: aud,
                    importance: imp,
                    imageURL: img,
                    likes: 0,
                    reports: 0,
                    tags: tagObj,
                    comments: 0
                }

            ref.child('Idea' + ideaNumber).set(data);

            postModal.style.display = "none";
        	document.getElementById("refresh").style.visibility = "visible";

       	}

        function addLike(currentPost){

	        counter = currentPost.id.match(/\d+/g)[0]; //regex to grab # from id

			likesNumber = dataHold["Idea" + counter]["likes"]; // retrieve likes to be updated

			if(likedAlrdy == false){ //check if post has already been liked
				newLikes = likesNumber + 1; //increment likes by 1
			} else { 
				newLikes = likesNumber;
			}

			likedAlrdy = !likedAlrdy; //toggle boolean

			increment = database.ref("Ideas/Idea" + counter);
			increment.update({likes: newLikes});

			document.getElementById("likesCount" + counter).innerHTML = newLikes //add 1 to the on screen like count

			document.getElementById("likesPost" + counter).innerHTML = newLikes //add 1 to the browsing page on-hover like count
		};

		function addComment(currentPost){

		    commentNumber = currentPost.id.match(/\d+/g)[0]; //regex to grab # from id
            comment = document.getElementById("commentTxt" + commentNumber).value;

            if(comment.length > 0){

	           updateKey = database.ref("Ideas/Idea" + commentNumber + "/comments");
		       updateKey.push(comment); //add to database

		       onScreenComments = document.getElementById("commentList" + commentNumber);

		       commentEntry = document.createElement("p");
			   commentEntry.className = "idea-comments";
			   commentEntry.appendChild(document.createTextNode(comment));

		       onScreenComments.appendChild(commentEntry); //add comment onscreen

	  		} else {

	  			alert("No comment has been inputted");

	  		};
		};

		function reported(currentPost){

        	counter = currentPost.id.match(/\d+/g)[0]; //regex to grab # from id

			reportNumber = dataHold["Idea" + counter]["reports"];

			increment = database.ref("Ideas/Idea" + counter);

			if(reportedAlrdy == false){ //check if post has already been reported
				newReported = reportNumber + 1;
				increment.update({reports: newReported}); //increment report number by 1
				alert("Your report has been recorded");
				reportedAlrdy = true;

				//remove post from firebase database if the number of reports are equal to or greater than 1/5 of the number of likes:

				likesNumber = dataHold["Idea" + counter]["likes"];

				if (likesNumber/5 <= newReported){
					increment.remove(); //removes idea from firebase database
				};
			};

		};

		function sortByLikes (){
        	reset();

        	//sort dataHold dictionary by likes: 

        	likesSorted = Object.values(dataHold);

        	likesSorted.sort(function(a, b) { return b.likes - a.likes; }); // Sort by likes

        	for (i = 0; i < likesSorted.length; i++){
        		showPost(likesSorted[i]); //redraw all posts
        	};
        };


        function sortByDate (){
        	reset();
        	entriesCount = Object.keys(dataHold).length + 1;

        	for (const i in dataHold) //draws posts in reverse order, from newest to oldest, looping through dataHold dictionary
            {
            	loopCount = parseInt(i.substring(i.length-1));
            	reversedCount = entriesCount - loopCount;
            	reversedKey = "Idea" + reversedCount;
                showPost(dataHold[reversedKey]);
            }
        };

        function reset(){
        	document.getElementById("postSection").innerHTML = "";
        	ideaNumber = counter = 0;
	        likedAlrdy = reportedAlrdy = false;
        };

        function showSuggested(){

       		document.getElementById("suggestions").style.display = "block"; //make visible

       		document.getElementById("suggestions").innerHTML = " "; //clear suggestions 

       		//the following code searches the firebase database to find tags that match the input:

       		ref.once("value", searchTags, errData);
       	};

       	function searchTags(data){
       		data = data.val();

       		input = document.getElementById("searchInput").value;
       		suggestionCounter = 0; //used limit # of tag suggestions to 4

       		baseLoop:
       		for (const idea in data){ //loops through ideas
       			for (const tags in data[idea]["tags"]){ //loops through all tags on each idea

       				singleTag = data[idea]["tags"][tags].toLowerCase(); //keep everything lower case

       				if (singleTag.includes(input.toLowerCase())){ //check if input is contained in any tags
       					newSuggestion = document.createElement("button");
       					newSuggestion.appendChild(document.createTextNode(singleTag));
       					newSuggestion.setAttribute("id","tagName: " + singleTag);
       					newSuggestion.setAttribute("onclick","showTagged(this)");
       					document.getElementById("suggestions").appendChild(newSuggestion);
       					suggestionCounter ++;
       					if (suggestionCounter > 3) { //maximize suggestionCounter to 4
       						break baseLoop;
       					};
       				};
       			};
       		};
       	};

       	function showTagged(tagName){ //searches through database for all posts that match this tag and then display them
       		reset();

       		tag = tagName.id.split("tagName: ")[1].toLowerCase();

        	//display only values with tag in dataHold dictionary:

        	dataList = Object.values(dataHold);
        	dataHold = {}; //reset dataHold to only contain tagged posts so that tagged posts can be sorted

        	for (i = 0; i < dataList.length; i++){ //loops through ideas
       			for (const tags in dataList[i]["tags"]){ //loops through all tags on each idea

       				currentTag = dataList[i]["tags"][tags].toLowerCase();

       				if (currentTag == tag){ //check if tag = 
       					showPost(dataList[i]); //redraw posts with tag match
       					dataHold["Idea" + i] = dataList[i];
       					break;
       				};
       			};
       		};

       		console.log(dataHold);
       		
       	};

       	function hideSuggested(){
       		document.getElementById("suggestions").style.display = "none";
       	};

		</script>
			

	</body>
</html>
